// Разработка 2018-2025 DinrusPro / Dinrus Group. РНЦП Динрус.

/*************************************************************************
   -------------------------------------------------------------------------
   $Id$
   $DateTime$
   Описание: Shared parameters manager.
             System for managing storage and retrieval of shared parameters.

   -------------------------------------------------------------------------
   История:
   - 29:04:2010: Created by Paul Slinger

*************************************************************************/

////////////////////////////////////////////////////////////////////////////////////////////////////
// Using the Shared Parameters System
// ----------------------------------
//
// 1) Declare a shared parameters structure
//
//      BEGIN_SHARED_PARAMS(SMySharedParams)
//
//        inline SMySharedParams(const string &_someData) : someData(_someData)
//        {
//        }
//
//        string	someData;
//
//      END_SHARED_PARAMS
//
// 2) Define type information for the shared parameters structure
//
//      DEFINE_SHARED_PARAMS_TYPE_INFO(SMySharedParams)
//
// 2) Generate a 32 bit crc (optional)
//
//      u32 crc32 = pSharedParamsUpr->GenerateCRC32("Name goes here");
//
// 3) Register the shared parameters
//
//      pSharedParamsUpr->Register(crc32, SMySharedParams("I like chocolate milk"));
//
//        or
//
//      pSharedParamsUpr->Register("MySharedParams", SMySharedParams("I like chocolate milk"));
//
// 4) Retrieve the shared parameters
//
//      SMySharedParamsConstPtr	pSharedParams = CastSharedParamsPtr<SMySharedParams>pSharedParamsUpr->Get(crc32);
//
//        or
//
//      SMySharedParamsConstPtr	pSharedParams = CastSharedParamsPtr<SMySharedParams>pSharedParamsUpr->Get("Name goes here");
//
// Additional Info
// ---------------
// The shared parameters manager stores a map of names internally in order to catch crc collisions.
// This means that in the unlikely event of a name crc collision, GenerateCRC32() will return 0.
// Register() and Get() will both return a null pointer.
////////////////////////////////////////////////////////////////////////////////////////////////////

#pragma once

#include <drx3D/Sys/ISystem.h>
#include <drx3D/CoreX/Memory/STLPoolAllocator_ManyElems.h>
#include <drx3D/CoreX/StlUtils.h>
#include "ISharedParamsUpr.h"
#include <drx3D/Act/ISharedParams.h>

////////////////////////////////////////////////////////////////////////////////////////////////////
// Shared parameters manager class.
// System for managing storage and retrieval of game parameters.
////////////////////////////////////////////////////////////////////////////////////////////////////
class CSharedParamsUpr : public ISharedParamsUpr
{
public:

	////////////////////////////////////////////////////////////////////////////////////////////////////
	// Default constructor.
	////////////////////////////////////////////////////////////////////////////////////////////////////
	CSharedParamsUpr();

	////////////////////////////////////////////////////////////////////////////////////////////////////
	// Destructor.
	////////////////////////////////////////////////////////////////////////////////////////////////////
	~CSharedParamsUpr();

	// ISharedParamsUpr

	////////////////////////////////////////////////////////////////////////////////////////////////////
	// Generate unique 32 bit crc.
	//
	// Params: pName - unique name
	//
	// Return: unique 32 bit crc
	////////////////////////////////////////////////////////////////////////////////////////////////////
	virtual u32 GenerateCRC32(tukk pName);

	////////////////////////////////////////////////////////////////////////////////////////////////////
	// Register shared parameters.
	//
	// Params: crc32        - unique 32 bit crc
	//				 sharedParams - shared parameters
	//
	// Return: pointer to shared parameters
	////////////////////////////////////////////////////////////////////////////////////////////////////
	virtual ISharedParamsConstPtr Register(u32 crc32, const ISharedParams& sharedParams);

	////////////////////////////////////////////////////////////////////////////////////////////////////
	// Register shared parameters.
	//
	// Params: pName        - unique name
	//				 sharedParams - shared parameters
	//
	// Return: pointer to shared parameters
	////////////////////////////////////////////////////////////////////////////////////////////////////
	virtual ISharedParamsConstPtr Register(tukk pName, const ISharedParams& sharedParams);

	////////////////////////////////////////////////////////////////////////////////////////////////////
	// Remove shared parameters.
	//
	// Params: crc32 - unique 32 bit crc
	////////////////////////////////////////////////////////////////////////////////////////////////////
	virtual void Remove(u32 crc32);

	////////////////////////////////////////////////////////////////////////////////////////////////////
	// Remove shared parameters.
	//
	// Params: pName - unique name
	////////////////////////////////////////////////////////////////////////////////////////////////////
	virtual void Remove(tukk pName);

	////////////////////////////////////////////////////////////////////////////////////////////////////
	// Remove all shared parameters by type.
	//
	// Params: typeInfo - type information of to be removed
	////////////////////////////////////////////////////////////////////////////////////////////////////
	virtual void RemoveByType(const CSharedParamsTypeInfo& typeInfo);

	////////////////////////////////////////////////////////////////////////////////////////////////////
	// Get shared parameters.
	//
	// Params: crc32 - unique 32 bit crc
	//
	// Return: pointer to shared parameters
	////////////////////////////////////////////////////////////////////////////////////////////////////
	virtual ISharedParamsConstPtr Get(u32 crc32) const;

	////////////////////////////////////////////////////////////////////////////////////////////////////
	// Get shared parameters.
	//
	// Params: pName - unique name
	//
	// Return: pointer to shared parameters
	////////////////////////////////////////////////////////////////////////////////////////////////////
	virtual ISharedParamsConstPtr Get(tukk pName) const;

	////////////////////////////////////////////////////////////////////////////////////////////////////
	// Reset.
	////////////////////////////////////////////////////////////////////////////////////////////////////
	virtual void Reset();

	////////////////////////////////////////////////////////////////////////////////////////////////////
	// Release.
	////////////////////////////////////////////////////////////////////////////////////////////////////
	virtual void Release();

	////////////////////////////////////////////////////////////////////////////////////////////////////
	// Get memory statistics.
	////////////////////////////////////////////////////////////////////////////////////////////////////
	virtual void GetMemoryStatistics(IDrxSizer* pSizer);

	// ~ISharedParamsUpr

	////////////////////////////////////////////////////////////////////////////////////////////////////
	// Lock.
	////////////////////////////////////////////////////////////////////////////////////////////////////
	void Lock();

	////////////////////////////////////////////////////////////////////////////////////////////////////
	// Unlock.
	////////////////////////////////////////////////////////////////////////////////////////////////////
	void Unlock();

private:

	////////////////////////////////////////////////////////////////////////////////////////////////////
	// Verify unlocked.
	////////////////////////////////////////////////////////////////////////////////////////////////////
	bool VerifyUnlocked() const;

	////////////////////////////////////////////////////////////////////////////////////////////////////
	// Map of names.
	////////////////////////////////////////////////////////////////////////////////////////////////////
	typedef std::unordered_map<u32, string, std::hash<u32>, std::equal_to<u32>, stl::STLPoolAllocator_ManyElems<std::pair<u32k, string>>> TNameMap;

	////////////////////////////////////////////////////////////////////////////////////////////////////
	// Map of shared parameters.
	////////////////////////////////////////////////////////////////////////////////////////////////////
	typedef std::unordered_map<u32, ISharedParamsPtr, std::hash<u32>, std::equal_to<u32>, stl::STLPoolAllocator_ManyElems<std::pair<u32k, ISharedParamsPtr>>> TRecordMap;

	TNameMap     m_names;

	TRecordMap   m_records;

	size_t       m_sizeOfSharedParams;

	bool         m_lock;

	mutable bool m_outputLockWarning;
};
